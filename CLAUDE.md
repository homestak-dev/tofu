# Tofu - Proxmox VM Provisioning with OpenTofu

Infrastructure-as-Code project for provisioning virtual machines on Proxmox VE using OpenTofu (Terraform-compatible).

## Quick Reference

```bash
# Deploy via iac-driver (recommended)
cd ../iac-driver && ./run.sh --scenario vm-roundtrip --host father

# Direct tofu commands (for debugging only)
cd envs/generic
tofu init
tofu plan -var-file=/tmp/tfvars.json
tofu apply -var-file=/tmp/tfvars.json
```

**Note:** Direct `tofu apply` requires a tfvars.json generated by iac-driver's ConfigResolver.

## Project Structure

```
tofu/
├── proxmox-vm/           # Reusable module: single VM provisioning
├── proxmox-file/         # Reusable module: cloud image management
├── proxmox-sdn/          # Reusable module: VXLAN SDN networking (future use)
└── envs/
    └── generic/          # Primary environment - receives config from iac-driver
```

## Architecture

### Config Resolution Flow

```
site-config/                    iac-driver/                    tofu/
┌─────────────┐                 ┌──────────────────┐           ┌─────────────┐
│ vms/        │                 │ ConfigResolver   │           │ envs/       │
│ ├─presets/  │───resolve──────▶│ - Load YAML      │──tfvars──▶│ generic/    │
│ └─*.yaml    │                 │ - Merge layers   │  .json    │             │
├─────────────┤                 │ - Resolve refs   │           │ for_each:   │
│ envs/*.yaml │                 └──────────────────┘           │   var.vms   │
├─────────────┤                                                └─────────────┘
│ nodes/*.yaml│
├─────────────┤
│ secrets.yaml│
└─────────────┘
```

**Benefits:**
- All config logic in Python (more capable than HCL)
- tofu is a "dumb executor" - no site-config knowledge
- Single source of config parsing (no duplication)
- Template/preset inheritance handled by iac-driver

### Generic Environment

The `envs/generic/` environment receives pre-resolved config from iac-driver:

```hcl
# Variables received from iac-driver
variable "vms" {
  type = list(object({
    name       = string
    vmid       = optional(number)
    image      = string
    cores      = number
    memory     = number
    disk       = number
    bridge     = optional(string, "vmbr0")
    ip         = optional(string, "dhcp")
    gateway    = optional(string)
    packages   = optional(list(string), [])
    auth_token = optional(string, "")  # v0.45+ - posture-based auth token
  }))
}

# automation_user (v0.41+): Non-root user for VM SSH access
variable "automation_user" {
  type    = string
  default = "homestak"  # Created via cloud-init with sudo access
}

# spec_server (v0.45+): Spec server URL for Create → Specify flow
variable "spec_server" {
  type    = string
  default = ""  # Empty = disabled, no env vars injected
}

# Simple for_each over resolved VMs
module "vm" {
  source   = "../../proxmox-vm"
  for_each = { for vm in var.vms : vm.name => vm }
  # ... use each.value.* directly
}
```

**User distinction:**
- `automation_user` (default: `homestak`) - Non-root user created on VMs via cloud-init, used for SSH access
- `ssh_user` (from site-config) - User for SSH to PVE hosts (typically `root`)

### Create → Specify Flow (v0.45+)

When `spec_server` is configured in `site.yaml`, VMs are provisioned with environment variables for automatic spec discovery:

```yaml
# Cloud-init writes /etc/profile.d/homestak.sh:
export HOMESTAK_SPEC_SERVER=https://father:44443
export HOMESTAK_IDENTITY=dev1
export HOMESTAK_AUTH_TOKEN=...  # Only if posture requires
```

**First-boot behavior:**
1. Cloud-init writes environment variables to `/etc/profile.d/homestak.sh`
2. runcmd checks if spec already exists
3. If not, runs `homestak spec get` to fetch spec from server
4. Spec saved to `/usr/local/etc/homestak/state/spec.yaml`

**Auth token by posture:**

| Posture | Auth Method | Token Value |
|---------|-------------|-------------|
| dev/local | network | (empty) |
| stage | site_token | Shared token from secrets |
| prod | node_token | Per-VM token from secrets |

The auth token is resolved by iac-driver's ConfigResolver based on the environment's posture.

## Related Projects

Part of the [homestak-dev](https://github.com/homestak-dev) organization:

| Repo | Purpose |
|------|---------|
| [bootstrap](https://github.com/homestak-dev/bootstrap) | Entry point - curl\|bash setup |
| [site-config](https://github.com/homestak-dev/site-config) | Site-specific secrets and configuration |
| [ansible](https://github.com/homestak-dev/ansible) | Proxmox host configuration, PVE installation |
| [iac-driver](https://github.com/homestak-dev/iac-driver) | Orchestration engine + ConfigResolver |
| [packer](https://github.com/homestak-dev/packer) | Custom Debian cloud images |
| [tofu](https://github.com/homestak-dev/tofu) | This project - VM provisioning |

## Key Technologies

- **OpenTofu** - IaC provisioning
- **bpg/proxmox provider v0.91.0** - Proxmox VE integration
- **Cloud-Init** - VM initialization
- **local-zfs** - Storage backend
- **Debian Cloud Images** - VM base (Bookworm 12, Trixie 13)

## Module Responsibilities

| Module | Purpose |
|--------|---------|
| `proxmox-vm` | Atomic VM resource (CPU, memory, disk, network, cloud-init) |
| `proxmox-file` | Cloud image management (local or URL source) |
| `proxmox-sdn` | VXLAN zone, vnet, and subnet configuration |
| `envs/generic` | Generic executor - loops over var.vms |

### Cloud Image Sources

The `proxmox-file` module supports two modes via `source_type`:

**Local (default)** - Uses pre-built packer images (~16s boot):
```hcl
module "cloud_image" {
  source        = "../../proxmox-file"
  local_file_id = "local:iso/debian-12-custom.img"
}
```

**URL** - Downloads from remote source (~35s boot):
```hcl
module "cloud_image" {
  source          = "../../proxmox-file"
  source_type     = "url"
  source_file_url = "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2"
  source_file_path = "debian-12-generic-amd64.img"
}
```

Packer images must be published before using local mode:
```bash
cd ../packer && ./publish.sh
```

## Conventions

- **VM IDs**: 5-digit numeric (vmid_base + index)
- **MAC prefix**: BC:24:11:*
- **Hostnames**: Defined in site-config/envs/*.yaml
- **Images**: Mapped via `var.images` (e.g., "debian-12" → "local:iso/debian-12-custom.img")

## Prerequisites

- OpenTofu CLI installed
- site-config repository set up and decrypted (see [site-config](https://github.com/homestak-dev/site-config))
- SSH key at `~/.ssh/id_rsa`
- Proxmox API access (endpoint + token in site-config)
- iac-driver for config resolution

## Known Issues

### Debian 12 Cloud-Init First-Boot Kernel Panic

Debian 12 cloud images can kernel panic on first boot when disk is expanded. Fix: add `serial_device {}` to VM resource config.

```hcl
resource "proxmox_virtual_environment_vm" "example" {
  # ... other config ...
  serial_device {}  # Prevents first-boot kernel panic
}
```

Reference: https://forum.proxmox.com/threads/160125/

### OpenTofu State Version 4 Bug

When `TF_DATA_DIR` contains a `terraform.tfstate` file, OpenTofu's legacy code path reads it and rejects valid v4 states with error:
```
Error: Failed to load state: OpenTofu 1.11.2 does not support state version 4, please update.
```

**Root Cause**: Legacy code in `internal/legacy/tofu/state.go` has `StateVersion = 3` and is incorrectly triggered when state exists in `TF_DATA_DIR`.

**Workaround**: Store state file outside `TF_DATA_DIR`:
```
.states/{env}-{node}/
├── data/                 # TF_DATA_DIR points here
│   ├── modules/
│   └── providers/
└── terraform.tfstate     # State file at parent level
```

iac-driver implements this workaround in all tofu actions. See [opentofu/opentofu#3643](https://github.com/opentofu/opentofu/issues/3643).

## Provider Documentation

- https://search.opentofu.org/provider/bpg/proxmox/latest
- https://github.com/bpg/terraform-provider-proxmox
