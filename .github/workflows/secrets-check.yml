name: Secrets Check

on:
  push:
    paths:
      - 'envs/**/terraform.tfvars*'
      - '.sops.yaml'
  pull_request:
    paths:
      - 'envs/**/terraform.tfvars*'
      - '.sops.yaml'

jobs:
  verify-encryption:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for plaintext terraform.tfvars
        run: |
          echo "Checking for plaintext terraform.tfvars files..."
          PLAINTEXT=$(find envs -name "terraform.tfvars" -type f ! -name "*.enc" 2>/dev/null || true)
          if [ -n "$PLAINTEXT" ]; then
            echo "::error::Plaintext terraform.tfvars detected:"
            echo "$PLAINTEXT"
            exit 1
          fi
          echo "No plaintext terraform.tfvars found."

      - name: Verify .enc files are SOPS-encrypted
        run: |
          echo "Verifying encrypted files..."
          FAILED=0
          for encfile in $(find envs -name "terraform.tfvars.enc" -type f 2>/dev/null); do
            # Check for SOPS metadata in both YAML and JSON formats
            if ! grep -qE '(^sops:|"sops":)' "$encfile" 2>/dev/null; then
              echo "::error::$encfile is not SOPS-encrypted"
              FAILED=1
            else
              echo "✓ $encfile"
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
          echo "All .enc files verified."

      - name: Check .sops.yaml exists
        run: |
          if [ ! -f .sops.yaml ]; then
            echo "::error::.sops.yaml configuration file missing"
            exit 1
          fi
          echo "✓ .sops.yaml exists"
