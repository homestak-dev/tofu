#!/bin/bash
# Auto-decrypt terraform.tfvars.enc files after checkout

cd "$(git rev-parse --show-toplevel)"

# Check if age key exists
if [ ! -f ~/.config/sops/age/keys.txt ]; then
    echo "Warning: No age key found at ~/.config/sops/age/keys.txt"
    echo "Run 'make setup' for instructions on setting up decryption."
    exit 0
fi

# Decrypt .enc files if plaintext is missing or older
for encfile in $(find envs -name "terraform.tfvars.enc" -type f 2>/dev/null); do
    plainfile="${encfile%.enc}"

    if [ ! -f "$plainfile" ] || [ "$encfile" -nt "$plainfile" ]; then
        echo "Decrypting: $encfile -> $plainfile"
        if ! sops -d "$encfile" > "$plainfile" 2>/dev/null; then
            echo "Warning: Failed to decrypt $encfile (wrong key?)"
            rm -f "$plainfile"
        fi
    fi
done
